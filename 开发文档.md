# OpenDSP 广告平台开发文档

## 项目概述

OpenDSP (Demand Side Platform) 是一个完整的程序化广告需求方平台，支持RTB (Real-Time Bidding) 实时竞价功能。该平台提供广告主投放管理、媒体资源对接、实时竞价、数据统计分析等核心功能。

## 技术架构

### 模块结构
```
opendsp/
├── opendsp-ads-engine/           # 广告引擎核心模块
│   ├── opendsp-ads-engine-core/  # 竞价逻辑核心实现
│   └── opendsp-ads-engine-serving/ # 竞价服务应用
├── opendsp-dashboard-api/        # 管理后台API
├── opendsp-event-serving/        # 事件处理服务
├── opendsp-dao/                  # 数据访问层
├── opendsp-proto/                # gRPC协议定义
├── opendsp-commons/              # 公共组件
└── sql/                          # 数据库脚本
```

### 技术栈
- **后端框架**: Spring Boot + MyBatis-Flex
- **数据库**: MySQL 8.0+
- **缓存**: Redis 6.0+
- **消息队列**: RabbitMQ/Kafka
- **RPC**: gRPC
- **监控**: Prometheus + Grafana

## 数据库设计

### 数据库结构

#### 1. 系统管理表 (01_create_database.sql)
```sql
-- 系统用户表
CREATE TABLE sys_user (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) UNIQUE NOT NULL,
    password VARCHAR(100) NOT NULL,
    email VARCHAR(100),
    real_name VARCHAR(50),
    phone VARCHAR(20),
    status TINYINT DEFAULT 1,
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- 系统角色表
CREATE TABLE sys_role (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    role_name VARCHAR(50) UNIQUE NOT NULL,
    description VARCHAR(200),
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 系统权限表
CREATE TABLE sys_permission (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    permission_name VARCHAR(100) UNIQUE NOT NULL,
    permission_code VARCHAR(50) UNIQUE NOT NULL,
    description VARCHAR(200),
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 系统菜单表
CREATE TABLE sys_menu (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    menu_name VARCHAR(50) NOT NULL,
    parent_id BIGINT DEFAULT 0,
    path VARCHAR(200),
    component VARCHAR(200),
    icon VARCHAR(100),
    sort_order INT DEFAULT 0,
    menu_type TINYINT DEFAULT 1,
    visible TINYINT DEFAULT 1,
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 系统字典表
CREATE TABLE sys_dict (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    dict_type VARCHAR(50) NOT NULL,
    dict_key VARCHAR(50) NOT NULL,
    dict_value VARCHAR(200) NOT NULL,
    description VARCHAR(200),
    sort_order INT DEFAULT 0,
    status TINYINT DEFAULT 1,
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 2. 广告主生态表 (02_advertiser_tables.sql)
```sql
-- 广告主表
CREATE TABLE advertiser (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    phone VARCHAR(20),
    company VARCHAR(200),
    industry VARCHAR(50),
    contact_person VARCHAR(50),
    address VARCHAR(500),
    status TINYINT DEFAULT 1,
    audit_status TINYINT DEFAULT 0,
    audit_reason VARCHAR(500),
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- 代理商表
CREATE TABLE agency (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    phone VARCHAR(20),
    company VARCHAR(200),
    contact_person VARCHAR(50),
    address VARCHAR(500),
    commission_rate DECIMAL(5,4) DEFAULT 0.0000,
    status TINYINT DEFAULT 1,
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- 广告主资质表
CREATE TABLE advertiser_qualification (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    advertiser_id BIGINT NOT NULL,
    qualification_type VARCHAR(50) NOT NULL,
    qualification_name VARCHAR(100) NOT NULL,
    qualification_number VARCHAR(100),
    qualification_file VARCHAR(500),
    expire_date DATE,
    status TINYINT DEFAULT 1,
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (advertiser_id) REFERENCES advertiser(id)
);

-- 广告主充值记录表
CREATE TABLE advertiser_recharge (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    advertiser_id BIGINT NOT NULL,
    amount DECIMAL(15,2) NOT NULL,
    recharge_type TINYINT NOT NULL,
    payment_method VARCHAR(50),
    transaction_id VARCHAR(100),
    status TINYINT DEFAULT 0,
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (advertiser_id) REFERENCES advertiser(id)
);

-- 广告主余额表
CREATE TABLE advertiser_balance (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    advertiser_id BIGINT UNIQUE NOT NULL,
    balance DECIMAL(15,2) DEFAULT 0.00,
    frozen_balance DECIMAL(15,2) DEFAULT 0.00,
    total_recharge DECIMAL(15,2) DEFAULT 0.00,
    total_consume DECIMAL(15,2) DEFAULT 0.00,
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (advertiser_id) REFERENCES advertiser(id)
);
```

#### 3. 活动管理表 (03_campaign_tables.sql)
```sql
-- 广告位表
CREATE TABLE ad_slot (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL,
    size VARCHAR(20) NOT NULL,
    position VARCHAR(50),
    ad_type TINYINT NOT NULL,
    floor_price DECIMAL(10,4) DEFAULT 0.0000,
    status TINYINT DEFAULT 1,
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- 活动表
CREATE TABLE campaign (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    advertiser_id BIGINT NOT NULL,
    name VARCHAR(100) NOT NULL,
    budget DECIMAL(15,2) NOT NULL,
    daily_budget DECIMAL(15,2),
    start_date DATE NOT NULL,
    end_date DATE NOT NULL,
    status TINYINT DEFAULT 1,
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (advertiser_id) REFERENCES advertiser(id)
);

-- 广告组表
CREATE TABLE ad_group (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    campaign_id BIGINT NOT NULL,
    advertiser_id BIGINT NOT NULL,
    name VARCHAR(100) NOT NULL,
    budget DECIMAL(15,2) NOT NULL,
    daily_budget DECIMAL(15,2),
    bid_strategy TINYINT DEFAULT 1,
    bid_price DECIMAL(10,4) NOT NULL,
    target_region VARCHAR(500),
    target_os VARCHAR(100),
    target_device_type VARCHAR(100),
    target_device_make VARCHAR(200),
    target_device_model VARCHAR(200),
    target_carrier VARCHAR(200),
    target_network VARCHAR(100),
    frequency_cap INT DEFAULT 0,
    frequency_cap_period INT DEFAULT 24,
    start_date DATE NOT NULL,
    end_date DATE NOT NULL,
    status TINYINT DEFAULT 1,
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (campaign_id) REFERENCES campaign(id),
    FOREIGN KEY (advertiser_id) REFERENCES advertiser(id)
);

-- 创意表
CREATE TABLE creative (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    ad_group_id BIGINT NOT NULL,
    advertiser_id BIGINT NOT NULL,
    name VARCHAR(100) NOT NULL,
    ad_type TINYINT NOT NULL,
    title VARCHAR(200),
    description VARCHAR(500),
    image_url VARCHAR(500),
    video_url VARCHAR(500),
    click_url VARCHAR(500) NOT NULL,
    width INT,
    height INT,
    duration INT,
    file_size BIGINT,
    status TINYINT DEFAULT 1,
    audit_status TINYINT DEFAULT 0,
    audit_reason VARCHAR(500),
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (ad_group_id) REFERENCES ad_group(id),
    FOREIGN KEY (advertiser_id) REFERENCES advertiser(id)
);

-- 原生广告规格表
CREATE TABLE native_ad_spec (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL,
    title_length INT DEFAULT 0,
    desc_length INT DEFAULT 0,
    icon_size VARCHAR(20),
    image_size VARCHAR(20),
    video_duration INT DEFAULT 0,
    status TINYINT DEFAULT 1,
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 4. 统计分析表 (04_statistics_tables.sql)
```sql
-- 广告统计表
CREATE TABLE ad_stats (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    advertiser_id BIGINT NOT NULL,
    campaign_id BIGINT NOT NULL,
    ad_group_id BIGINT NOT NULL,
    creative_id BIGINT NOT NULL,
    ad_slot_id BIGINT NOT NULL,
    stat_date DATE NOT NULL,
    stat_hour TINYINT NOT NULL,
    bid_requests INT DEFAULT 0,
    bid_responses INT DEFAULT 0,
    wins INT DEFAULT 0,
    impressions INT DEFAULT 0,
    clicks INT DEFAULT 0,
    conversions INT DEFAULT 0,
    cost DECIMAL(15,2) DEFAULT 0.00,
    ctr DECIMAL(8,6) DEFAULT 0.000000,
    cvr DECIMAL(8,6) DEFAULT 0.000000,
    cpm DECIMAL(10,4) DEFAULT 0.0000,
    cpc DECIMAL(10,4) DEFAULT 0.0000,
    cpa DECIMAL(10,4) DEFAULT 0.0000,
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY uk_stats (advertiser_id, campaign_id, ad_group_id, creative_id, ad_slot_id, stat_date, stat_hour)
);

-- 竞价日志表
CREATE TABLE bid_log (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    request_id VARCHAR(100) NOT NULL,
    advertiser_id BIGINT,
    campaign_id BIGINT,
    ad_group_id BIGINT,
    creative_id BIGINT,
    ad_slot_id BIGINT,
    bid_price DECIMAL(10,4),
    win_price DECIMAL(10,4),
    bid_result TINYINT NOT NULL,
    user_id VARCHAR(100),
    device_id VARCHAR(100),
    ip VARCHAR(50),
    user_agent VARCHAR(500),
    region VARCHAR(100),
    city VARCHAR(100),
    device_type VARCHAR(50),
    device_make VARCHAR(50),
    device_model VARCHAR(50),
    os VARCHAR(50),
    os_version VARCHAR(50),
    carrier VARCHAR(50),
    network VARCHAR(50),
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_request_id (request_id),
    INDEX idx_create_time (create_time),
    INDEX idx_advertiser_id (advertiser_id)
);

-- 展示日志表
CREATE TABLE impression_log (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    request_id VARCHAR(100) NOT NULL,
    advertiser_id BIGINT NOT NULL,
    campaign_id BIGINT NOT NULL,
    ad_group_id BIGINT NOT NULL,
    creative_id BIGINT NOT NULL,
    ad_slot_id BIGINT NOT NULL,
    user_id VARCHAR(100),
    device_id VARCHAR(100),
    ip VARCHAR(50),
    user_agent VARCHAR(500),
    region VARCHAR(100),
    city VARCHAR(100),
    device_type VARCHAR(50),
    os VARCHAR(50),
    carrier VARCHAR(50),
    network VARCHAR(50),
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_request_id (request_id),
    INDEX idx_create_time (create_time),
    INDEX idx_advertiser_id (advertiser_id)
);

-- 点击日志表  
CREATE TABLE click_log (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    request_id VARCHAR(100) NOT NULL,
    advertiser_id BIGINT NOT NULL,
    campaign_id BIGINT NOT NULL,
    ad_group_id BIGINT NOT NULL,
    creative_id BIGINT NOT NULL,
    ad_slot_id BIGINT NOT NULL,
    user_id VARCHAR(100),
    device_id VARCHAR(100),
    ip VARCHAR(50),
    user_agent VARCHAR(500),
    region VARCHAR(100),
    city VARCHAR(100),
    device_type VARCHAR(50),
    os VARCHAR(50),
    carrier VARCHAR(50),
    network VARCHAR(50),
    click_url VARCHAR(500),
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_request_id (request_id),
    INDEX idx_create_time (create_time),
    INDEX idx_advertiser_id (advertiser_id)
);

-- 转化日志表
CREATE TABLE conversion_log (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    request_id VARCHAR(100) NOT NULL,
    advertiser_id BIGINT NOT NULL,
    campaign_id BIGINT NOT NULL,
    ad_group_id BIGINT NOT NULL,
    creative_id BIGINT NOT NULL,
    ad_slot_id BIGINT NOT NULL,
    user_id VARCHAR(100),
    device_id VARCHAR(100),
    conversion_type VARCHAR(50),
    conversion_value DECIMAL(10,2),
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_request_id (request_id),
    INDEX idx_create_time (create_time),
    INDEX idx_advertiser_id (advertiser_id)
);

-- 财务结算表
CREATE TABLE financial_settlement (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    advertiser_id BIGINT NOT NULL,
    settlement_date DATE NOT NULL,
    total_cost DECIMAL(15,2) NOT NULL,
    total_impressions INT DEFAULT 0,
    total_clicks INT DEFAULT 0,
    total_conversions INT DEFAULT 0,
    avg_cpm DECIMAL(10,4) DEFAULT 0.0000,
    avg_cpc DECIMAL(10,4) DEFAULT 0.0000,
    avg_cpa DECIMAL(10,4) DEFAULT 0.0000,
    status TINYINT DEFAULT 0,
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY uk_settlement (advertiser_id, settlement_date)
);
```

#### 5. 初始化数据 (05_init_data.sql)
```sql
-- 系统字典数据
INSERT INTO sys_dict (dict_type, dict_key, dict_value, description, sort_order) VALUES
('user_status', '0', '禁用', '用户状态：禁用', 1),
('user_status', '1', '正常', '用户状态：正常', 2),
('advertiser_status', '0', '禁用', '广告主状态：禁用', 1),
('advertiser_status', '1', '正常', '广告主状态：正常', 2),
('audit_status', '0', '待审核', '审核状态：待审核', 1),
('audit_status', '1', '审核通过', '审核状态：审核通过', 2),
('audit_status', '2', '审核拒绝', '审核状态：审核拒绝', 3),
('ad_type', '1', 'Banner', '广告类型：横幅广告', 1),
('ad_type', '2', 'Video', '广告类型：视频广告', 2),
('ad_type', '3', 'Native', '广告类型：原生广告', 3),
('bid_strategy', '1', 'CPM', '竞价策略：按千次展示付费', 1),
('bid_strategy', '2', 'CPC', '竞价策略：按点击付费', 2),
('bid_strategy', '3', 'CPA', '竞价策略：按转化付费', 3),
('bid_strategy', '4', 'oCPM', '竞价策略：优化千次展示付费', 4),
('bid_strategy', '5', 'oCPC', '竞价策略：优化点击付费', 5);

-- 创建默认管理员用户 (用户名: admin, 密码: admin123)
INSERT INTO sys_user (username, password, email, real_name, phone, status) VALUES
('admin', '$2a$10$7JB720yubVSQLJ8WzaKT8OUfbYMhZQpZQEWQNZHO7aLKCyeOCOZsW', 'admin@opendsp.com', '系统管理员', '18888888888', 1);

-- 创建默认角色
INSERT INTO sys_role (role_name, description) VALUES
('SUPER_ADMIN', '超级管理员'),
('ADMIN', '系统管理员'),
('ADVERTISER', '广告主'),
('AGENCY', '代理商');

-- 创建默认权限
INSERT INTO sys_permission (permission_name, permission_code, description) VALUES
('用户管理', 'sys:user:view', '查看用户列表'),
('用户新增', 'sys:user:add', '新增用户'),
('用户编辑', 'sys:user:edit', '编辑用户'),
('用户删除', 'sys:user:delete', '删除用户'),
('角色管理', 'sys:role:view', '查看角色列表'),
('权限管理', 'sys:permission:view', '查看权限列表'),
('广告主管理', 'advertiser:view', '查看广告主列表'),
('广告主审核', 'advertiser:audit', '审核广告主'),
('活动管理', 'campaign:view', '查看活动列表'),
('广告组管理', 'adgroup:view', '查看广告组列表'),
('创意管理', 'creative:view', '查看创意列表'),
('统计报表', 'stats:view', '查看统计报表');

-- 用户角色关联
INSERT INTO sys_user_role (user_id, role_id) VALUES (1, 1);

-- 默认广告位数据
INSERT INTO ad_slot (name, size, position, ad_type, floor_price) VALUES
('首页Banner', '728x90', '首页顶部', 1, 2.0000),
('内容页Banner', '300x250', '内容页右侧', 1, 1.5000),
('移动端Banner', '320x50', '移动端顶部', 1, 1.0000),
('视频前贴片', '1280x720', '视频播放前', 2, 5.0000),
('原生信息流', '自适应', '信息流中', 3, 3.0000);

-- 默认原生广告规格
INSERT INTO native_ad_spec (name, title_length, desc_length, icon_size, image_size, video_duration) VALUES
('标准信息流', 30, 100, '100x100', '1200x628', 0),
('大图信息流', 25, 80, '100x100', '1200x900', 0),
('视频信息流', 20, 60, '100x100', '1200x628', 30),
('小图信息流', 35, 120, '100x100', '600x400', 0);
```

## 核心功能实现

### 1. 竞价引擎核心服务 (BiddingServiceImpl.java)

```java
@Service
@Slf4j
public class BiddingServiceImpl implements BiddingService {
    
    @Autowired
    private AdMatchingService adMatchingService;
    
    @Autowired
    private TargetingService targetingService;
    
    @Autowired
    private BudgetService budgetService;
    
    @Autowired
    private FrequencyCapService frequencyCapService;
    
    @Autowired
    private PricingService pricingService;
    
    @Autowired
    private BidLogService bidLogService;
    
    @Override
    public ResponseFuture<BidResponse> processBidRequest(BidRequest request) {
        String requestId = request.getRequestId();
        
        try {
            // 1. 请求验证
            if (!validateBidRequest(request)) {
                return createNoBidResponse(requestId, "Invalid bid request");
            }
            
            // 2. 广告匹配
            List<AdCandidate> candidates = adMatchingService.matchAds(request);
            if (candidates.isEmpty()) {
                return createNoBidResponse(requestId, "No matching ads");
            }
            
            // 3. 定向过滤
            List<AdCandidate> targetedCandidates = targetingService.filterByTargeting(candidates, request);
            if (targetedCandidates.isEmpty()) {
                return createNoBidResponse(requestId, "No targeted ads");
            }
            
            // 4. 预算检查
            List<AdCandidate> budgetFilteredCandidates = budgetService.filterByBudget(targetedCandidates);
            if (budgetFilteredCandidates.isEmpty()) {
                return createNoBidResponse(requestId, "No budget available");
            }
            
            // 5. 频次控制
            List<AdCandidate> frequencyFilteredCandidates = frequencyCapService.filterByFrequency(
                budgetFilteredCandidates, request.getUser().getId());
            if (frequencyFilteredCandidates.isEmpty()) {
                return createNoBidResponse(requestId, "Frequency cap exceeded");
            }
            
            // 6. 竞价计算
            AdCandidate winner = pricingService.calculateBidPrice(frequencyFilteredCandidates, request);
            if (winner == null) {
                return createNoBidResponse(requestId, "No viable bid");
            }
            
            // 7. 构建响应
            BidResponse response = buildBidResponse(winner, request);
            
            // 异步记录竞价日志
            bidLogService.logBidResult(request, winner, true);
            
            return ResponseFuture.completedFuture(response);
            
        } catch (Exception e) {
            log.error("Error processing bid request: {}", requestId, e);
            bidLogService.logBidResult(request, null, false);
            return createNoBidResponse(requestId, "Internal error");
        }
    }
    
    private boolean validateBidRequest(BidRequest request) {
        return request != null 
            && StringUtils.isNotBlank(request.getRequestId())
            && request.getSlot() != null
            && request.getUser() != null
            && request.getDevice() != null;
    }
    
    private ResponseFuture<BidResponse> createNoBidResponse(String requestId, String reason) {
        BidResponse response = BidResponse.newBuilder()
            .setRequestId(requestId)
            .setHasBid(false)
            .setReason(reason)
            .build();
        return ResponseFuture.completedFuture(response);
    }
    
    private BidResponse buildBidResponse(AdCandidate winner, BidRequest request) {
        return BidResponse.newBuilder()
            .setRequestId(request.getRequestId())
            .setHasBid(true)
            .setAdGroupId(winner.getAdGroupId())
            .setCreativeId(winner.getCreativeId())
            .setBidPrice(winner.getBidPrice())
            .setClickUrl(winner.getClickUrl())
            .setImageUrl(winner.getImageUrl())
            .setTitle(winner.getTitle())
            .setDescription(winner.getDescription())
            .build();
    }
}
```

### 2. 广告匹配服务 (AdMatchingService.java)

```java
@Service
@Slf4j
public class AdMatchingService {
    
    @Autowired
    private AdGroupDao adGroupDao;
    
    @Autowired
    private CreativeDao creativeDao;
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    public List<AdCandidate> matchAds(BidRequest request) {
        List<AdCandidate> candidates = new ArrayList<>();
        
        try {
            // 1. 根据广告位特征匹配活跃的广告组
            List<AdGroup> activeAdGroups = findActiveAdGroups(request.getSlot());
            
            // 2. 为每个广告组找到对应的创意
            for (AdGroup adGroup : activeAdGroups) {
                List<Creative> creatives = findActiveCreatives(adGroup.getId(), request.getSlot().getAdType());
                
                for (Creative creative : creatives) {
                    AdCandidate candidate = new AdCandidate();
                    candidate.setAdvertiserId(adGroup.getAdvertiserId());
                    candidate.setCampaignId(adGroup.getCampaignId());
                    candidate.setAdGroupId(adGroup.getId());
                    candidate.setCreativeId(creative.getId());
                    candidate.setAdGroup(adGroup);
                    candidate.setCreative(creative);
                    candidate.setBaseBidPrice(adGroup.getBidPrice());
                    
                    candidates.add(candidate);
                }
            }
            
            log.info("Found {} ad candidates for slot {}", candidates.size(), request.getSlot().getId());
            
        } catch (Exception e) {
            log.error("Error matching ads for request: {}", request.getRequestId(), e);
        }
        
        return candidates;
    }
    
    private List<AdGroup> findActiveAdGroups(AdSlot slot) {
        // 缓存键
        String cacheKey = "active_adgroups:" + slot.getId();
        
        // 尝试从缓存获取
        @SuppressWarnings("unchecked")
        List<AdGroup> cachedAdGroups = (List<AdGroup>) redisTemplate.opsForValue().get(cacheKey);
        if (cachedAdGroups != null) {
            return cachedAdGroups;
        }
        
        // 从数据库查询
        Date now = new Date();
        List<AdGroup> adGroups = adGroupDao.findActiveAdGroups(slot.getAdType(), now);
        
        // 缓存结果（5分钟过期）
        redisTemplate.opsForValue().set(cacheKey, adGroups, Duration.ofMinutes(5));
        
        return adGroups;
    }
    
    private List<Creative> findActiveCreatives(Long adGroupId, Integer adType) {
        // 缓存键
        String cacheKey = "active_creatives:" + adGroupId + ":" + adType;
        
        // 尝试从缓存获取
        @SuppressWarnings("unchecked")
        List<Creative> cachedCreatives = (List<Creative>) redisTemplate.opsForValue().get(cacheKey);
        if (cachedCreatives != null) {
            return cachedCreatives;
        }
        
        // 从数据库查询
        List<Creative> creatives = creativeDao.findActiveCreatives(adGroupId, adType);
        
        // 缓存结果（10分钟过期）
        redisTemplate.opsForValue().set(cacheKey, creatives, Duration.ofMinutes(10));
        
        return creatives;
    }
}
```

### 3. 定向过滤服务 (TargetingService.java)

```java
@Service
@Slf4j
public class TargetingService {
    
    public List<AdCandidate> filterByTargeting(List<AdCandidate> candidates, BidRequest request) {
        List<AdCandidate> filteredCandidates = new ArrayList<>();
        
        for (AdCandidate candidate : candidates) {
            if (isTargetingMatch(candidate, request)) {
                filteredCandidates.add(candidate);
            }
        }
        
        log.info("Targeting filtered {} candidates from {} for request: {}", 
            filteredCandidates.size(), candidates.size(), request.getRequestId());
        
        return filteredCandidates;
    }
    
    private boolean isTargetingMatch(AdCandidate candidate, BidRequest request) {
        AdGroup adGroup = candidate.getAdGroup();
        Device device = request.getDevice();
        User user = request.getUser();
        
        // 1. 地域定向
        if (!isRegionMatch(adGroup.getTargetRegion(), user.getRegion())) {
            return false;
        }
        
        // 2. 操作系统定向
        if (!isOsMatch(adGroup.getTargetOs(), device.getOs())) {
            return false;
        }
        
        // 3. 设备类型定向
        if (!isDeviceTypeMatch(adGroup.getTargetDeviceType(), device.getDeviceType())) {
            return false;
        }
        
        // 4. 设备品牌定向
        if (!isDeviceMakeMatch(adGroup.getTargetDeviceMake(), device.getMake())) {
            return false;
        }
        
        // 5. 设备型号定向
        if (!isDeviceModelMatch(adGroup.getTargetDeviceModel(), device.getModel())) {
            return false;
        }
        
        // 6. 运营商定向
        if (!isCarrierMatch(adGroup.getTargetCarrier(), device.getCarrier())) {
            return false;
        }
        
        // 7. 网络类型定向
        if (!isNetworkMatch(adGroup.getTargetNetwork(), device.getNetwork())) {
            return false;
        }
        
        return true;
    }
    
    private boolean isRegionMatch(String targetRegion, String userRegion) {
        if (StringUtils.isBlank(targetRegion)) {
            return true; // 无定向限制
        }
        
        if (StringUtils.isBlank(userRegion)) {
            return false; // 用户地域信息缺失
        }
        
        // 支持多地域定向，逗号分隔
        String[] targetRegions = targetRegion.split(",");
        for (String region : targetRegions) {
            if (userRegion.contains(region.trim())) {
                return true;
            }
        }
        
        return false;
    }
    
    private boolean isOsMatch(String targetOs, String deviceOs) {
        if (StringUtils.isBlank(targetOs)) {
            return true;
        }
        
        if (StringUtils.isBlank(deviceOs)) {
            return false;
        }
        
        String[] targetOsList = targetOs.split(",");
        for (String os : targetOsList) {
            if (deviceOs.toLowerCase().contains(os.trim().toLowerCase())) {
                return true;
            }
        }
        
        return false;
    }
    
    private boolean isDeviceTypeMatch(String targetDeviceType, String deviceType) {
        if (StringUtils.isBlank(targetDeviceType)) {
            return true;
        }
        
        if (StringUtils.isBlank(deviceType)) {
            return false;
        }
        
        String[] targetTypes = targetDeviceType.split(",");
        for (String type : targetTypes) {
            if (deviceType.equalsIgnoreCase(type.trim())) {
                return true;
            }
        }
        
        return false;
    }
    
    private boolean isDeviceMakeMatch(String targetMake, String deviceMake) {
        if (StringUtils.isBlank(targetMake)) {
            return true;
        }
        
        if (StringUtils.isBlank(deviceMake)) {
            return false;
        }
        
        String[] targetMakes = targetMake.split(",");
        for (String make : targetMakes) {
            if (deviceMake.toLowerCase().contains(make.trim().toLowerCase())) {
                return true;
            }
        }
        
        return false;
    }
    
    private boolean isDeviceModelMatch(String targetModel, String deviceModel) {
        if (StringUtils.isBlank(targetModel)) {
            return true;
        }
        
        if (StringUtils.isBlank(deviceModel)) {
            return false;
        }
        
        String[] targetModels = targetModel.split(",");
        for (String model : targetModels) {
            if (deviceModel.toLowerCase().contains(model.trim().toLowerCase())) {
                return true;
            }
        }
        
        return false;
    }
    
    private boolean isCarrierMatch(String targetCarrier, String deviceCarrier) {
        if (StringUtils.isBlank(targetCarrier)) {
            return true;
        }
        
        if (StringUtils.isBlank(deviceCarrier)) {
            return false;
        }
        
        String[] targetCarriers = targetCarrier.split(",");
        for (String carrier : targetCarriers) {
            if (deviceCarrier.toLowerCase().contains(carrier.trim().toLowerCase())) {
                return true;
            }
        }
        
        return false;
    }
    
    private boolean isNetworkMatch(String targetNetwork, String deviceNetwork) {
        if (StringUtils.isBlank(targetNetwork)) {
            return true;
        }
        
        if (StringUtils.isBlank(deviceNetwork)) {
            return false;
        }
        
        String[] targetNetworks = targetNetwork.split(",");
        for (String network : targetNetworks) {
            if (deviceNetwork.equalsIgnoreCase(network.trim())) {
                return true;
            }
        }
        
        return false;
    }
}
```

### 4. 预算管理服务 (BudgetService.java)

```java
@Service
@Slf4j
public class BudgetService {
    
    @Autowired
    private AdvertiserDao advertiserDao;
    
    @Autowired
    private AdGroupDao adGroupDao;
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    // 内存缓存，提升性能
    private final Map<Long, BigDecimal> budgetCache = new ConcurrentHashMap<>();
    private final Map<Long, BigDecimal> dailyBudgetCache = new ConcurrentHashMap<>();
    
    public List<AdCandidate> filterByBudget(List<AdCandidate> candidates) {
        List<AdCandidate> filteredCandidates = new ArrayList<>();
        
        for (AdCandidate candidate : candidates) {
            if (hasSufficientBudget(candidate)) {
                filteredCandidates.add(candidate);
            }
        }
        
        log.info("Budget filtered {} candidates from {}", filteredCandidates.size(), candidates.size());
        
        return filteredCandidates;
    }
    
    private boolean hasSufficientBudget(AdCandidate candidate) {
        Long advertiserId = candidate.getAdvertiserId();
        Long adGroupId = candidate.getAdGroupId();
        
        // 1. 检查广告主余额
        if (!checkAdvertiserBalance(advertiserId, candidate.getBaseBidPrice())) {
            return false;
        }
        
        // 2. 检查广告组日预算
        if (!checkAdGroupDailyBudget(adGroupId, candidate.getBaseBidPrice())) {
            return false;
        }
        
        return true;
    }
    
    private boolean checkAdvertiserBalance(Long advertiserId, BigDecimal bidPrice) {
        // 先从内存缓存获取
        BigDecimal cachedBalance = budgetCache.get(advertiserId);
        if (cachedBalance != null) {
            return cachedBalance.compareTo(bidPrice) >= 0;
        }
        
        // 从Redis获取
        String balanceKey = "advertiser_balance:" + advertiserId;
        Object balanceObj = redisTemplate.opsForValue().get(balanceKey);
        
        BigDecimal balance;
        if (balanceObj != null) {
            balance = new BigDecimal(balanceObj.toString());
        } else {
            // 从数据库查询
            balance = advertiserDao.getBalance(advertiserId);
            if (balance == null) {
                balance = BigDecimal.ZERO;
            }
            
            // 缓存到Redis（1分钟过期）
            redisTemplate.opsForValue().set(balanceKey, balance, Duration.ofMinutes(1));
        }
        
        // 缓存到内存（30秒过期）
        budgetCache.put(advertiserId, balance);
        
        return balance.compareTo(bidPrice) >= 0;
    }
    
    private boolean checkAdGroupDailyBudget(Long adGroupId, BigDecimal bidPrice) {
        // 先从内存缓存获取
        BigDecimal cachedDailyBudget = dailyBudgetCache.get(adGroupId);
        if (cachedDailyBudget != null) {
            return cachedDailyBudget.compareTo(bidPrice) >= 0;
        }
        
        // 从Redis获取当日已消费金额
        String todayKey = "daily_spend:" + adGroupId + ":" + LocalDate.now().format(DateTimeFormatter.BASIC_ISO_DATE);
        Object spentObj = redisTemplate.opsForValue().get(todayKey);
        
        BigDecimal todaySpent = BigDecimal.ZERO;
        if (spentObj != null) {
            todaySpent = new BigDecimal(spentObj.toString());
        }
        
        // 获取广告组日预算
        AdGroup adGroup = adGroupDao.findById(adGroupId);
        if (adGroup == null || adGroup.getDailyBudget() == null) {
            return true; // 无日预算限制
        }
        
        BigDecimal remainingBudget = adGroup.getDailyBudget().subtract(todaySpent);
        
        // 缓存到内存（30秒过期）
        dailyBudgetCache.put(adGroupId, remainingBudget);
        
        return remainingBudget.compareTo(bidPrice) >= 0;
    }
    
    public void deductBudget(Long advertiserId, Long adGroupId, BigDecimal amount) {
        // 扣减广告主余额
        String balanceKey = "advertiser_balance:" + advertiserId;
        redisTemplate.opsForValue().decrement(balanceKey, amount.doubleValue());
        
        // 增加广告组当日消费
        String todayKey = "daily_spend:" + adGroupId + ":" + LocalDate.now().format(DateTimeFormatter.BASIC_ISO_DATE);
        redisTemplate.opsForValue().increment(todayKey, amount.doubleValue());
        redisTemplate.expire(todayKey, Duration.ofDays(1));
        
        // 清除内存缓存
        budgetCache.remove(advertiserId);
        dailyBudgetCache.remove(adGroupId);
        
        log.info("Deducted budget {} for advertiser {} adGroup {}", amount, advertiserId, adGroupId);
    }
    
    // 定时任务：每30秒清理过期的内存缓存
    @Scheduled(fixedDelay = 30000)
    public void cleanupExpiredCache() {
        budgetCache.clear();
        dailyBudgetCache.clear();
    }
}
```

### 5. 频次控制服务 (FrequencyCapService.java)

```java
@Service
@Slf4j
public class FrequencyCapService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    public List<AdCandidate> filterByFrequency(List<AdCandidate> candidates, String userId) {
        if (StringUtils.isBlank(userId)) {
            return candidates; // 无用户ID，跳过频次控制
        }
        
        List<AdCandidate> filteredCandidates = new ArrayList<>();
        
        for (AdCandidate candidate : candidates) {
            if (isFrequencyAllowed(candidate, userId)) {
                filteredCandidates.add(candidate);
            }
        }
        
        log.info("Frequency filtered {} candidates from {} for user: {}", 
            filteredCandidates.size(), candidates.size(), userId);
        
        return filteredCandidates;
    }
    
    private boolean isFrequencyAllowed(AdCandidate candidate, String userId) {
        AdGroup adGroup = candidate.getAdGroup();
        
        // 检查是否设置了频次限制
        if (adGroup.getFrequencyCap() == null || adGroup.getFrequencyCap() <= 0) {
            return true; // 无频次限制
        }
        
        // 获取频次限制周期（小时）
        int periodHours = adGroup.getFrequencyCapPeriod() != null ? adGroup.getFrequencyCapPeriod() : 24;
        
        // 构建Redis键
        String frequencyKey = buildFrequencyKey(candidate.getAdGroupId(), userId, periodHours);
        
        // 获取当前频次
        Object currentFreqObj = redisTemplate.opsForValue().get(frequencyKey);
        int currentFreq = currentFreqObj != null ? Integer.parseInt(currentFreqObj.toString()) : 0;
        
        // 检查是否超过频次限制
        return currentFreq < adGroup.getFrequencyCap();
    }
    
    private String buildFrequencyKey(Long adGroupId, String userId, int periodHours) {
        // 根据周期计算时间窗口
        LocalDateTime now = LocalDateTime.now();
        LocalDateTime windowStart = now.truncatedTo(ChronoUnit.HOURS).minusHours(now.getHour() % periodHours);
        
        return String.format("frequency:%d:%s:%s", adGroupId, userId, 
            windowStart.format(DateTimeFormatter.ofPattern("yyyyMMddHH")));
    }
    
    public void recordImpression(Long adGroupId, String userId) {
        if (StringUtils.isBlank(userId)) {
            return;
        }
        
        // 获取广告组信息
        AdGroup adGroup = getAdGroupById(adGroupId);
        if (adGroup == null || adGroup.getFrequencyCap() == null || adGroup.getFrequencyCap() <= 0) {
            return;
        }
        
        int periodHours = adGroup.getFrequencyCapPeriod() != null ? adGroup.getFrequencyCapPeriod() : 24;
        String frequencyKey = buildFrequencyKey(adGroupId, userId, periodHours);
        
        // 增加频次计数
        redisTemplate.opsForValue().increment(frequencyKey);
        
        // 设置过期时间
        redisTemplate.expire(frequencyKey, Duration.ofHours(periodHours));
        
        log.debug("Recorded impression for adGroup {} user {} key {}", adGroupId, userId, frequencyKey);
    }
    
    public int getUserFrequency(Long adGroupId, String userId) {
        if (StringUtils.isBlank(userId)) {
            return 0;
        }
        
        AdGroup adGroup = getAdGroupById(adGroupId);
        if (adGroup == null) {
            return 0;
        }
        
        int periodHours = adGroup.getFrequencyCapPeriod() != null ? adGroup.getFrequencyCapPeriod() : 24;
        String frequencyKey = buildFrequencyKey(adGroupId, userId, periodHours);
        
        Object freqObj = redisTemplate.opsForValue().get(frequencyKey);
        return freqObj != null ? Integer.parseInt(freqObj.toString()) : 0;
    }
    
    private AdGroup getAdGroupById(Long adGroupId) {
        // 这里应该从缓存或数据库获取AdGroup信息
        // 为简化示例，返回null
        return null;
    }
}
```

### 6. 智能定价服务 (PricingService.java)

```java
@Service
@Slf4j
public class PricingService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    @Autowired
    private AdStatsDao adStatsDao;
    
    public AdCandidate calculateBidPrice(List<AdCandidate> candidates, BidRequest request) {
        if (candidates.isEmpty()) {
            return null;
        }
        
        // 对每个候选广告计算竞价分数
        List<AdCandidate> scoredCandidates = new ArrayList<>();
        
        for (AdCandidate candidate : candidates) {
            double score = calculateBidScore(candidate, request);
            candidate.setBidScore(score);
            
            // 根据竞价策略计算最终出价
            BigDecimal finalBidPrice = calculateFinalBidPrice(candidate, request);
            candidate.setBidPrice(finalBidPrice);
            
            scoredCandidates.add(candidate);
        }
        
        // 按分数排序，选择最高分的候选广告
        scoredCandidates.sort((a, b) -> Double.compare(b.getBidScore(), a.getBidScore()));
        
        AdCandidate winner = scoredCandidates.get(0);
        
        // 检查是否满足最低出价要求
        if (winner.getBidPrice().compareTo(request.getSlot().getFloorPrice()) < 0) {
            log.debug("Winning bid {} below floor price {} for slot {}", 
                winner.getBidPrice(), request.getSlot().getFloorPrice(), request.getSlot().getId());
            return null;
        }
        
        log.info("Selected winner: adGroup {} creative {} bidPrice {} score {}", 
            winner.getAdGroupId(), winner.getCreativeId(), winner.getBidPrice(), winner.getBidScore());
        
        return winner;
    }
    
    private double calculateBidScore(AdCandidate candidate, BidRequest request) {
        double score = 0.0;
        
        // 1. 基础分数（根据历史表现）
        double baseScore = calculateBaseScore(candidate);
        score += baseScore * 0.4;
        
        // 2. 质量分数（CTR预估）
        double qualityScore = calculateQualityScore(candidate, request);
        score += qualityScore * 0.3;
        
        // 3. 竞价分数（出价竞争力）
        double bidScore = calculateBidCompetitiveness(candidate, request);
        score += bidScore * 0.2;
        
        // 4. 相关性分数
        double relevanceScore = calculateRelevanceScore(candidate, request);
        score += relevanceScore * 0.1;
        
        return score;
    }
    
    private double calculateBaseScore(AdCandidate candidate) {
        // 从缓存获取历史表现数据
        String statsKey = "ad_stats:" + candidate.getAdGroupId();
        Object statsObj = redisTemplate.opsForHash().get(statsKey, "performance");
        
        if (statsObj != null) {
            // 假设性能数据格式：CTR:0.02,CVR:0.05,Quality:0.8
            String[] metrics = statsObj.toString().split(",");
            double ctr = Double.parseDouble(metrics[0].split(":")[1]);
            double cvr = Double.parseDouble(metrics[1].split(":")[1]);
            double quality = Double.parseDouble(metrics[2].split(":")[1]);
            
            return (ctr * 0.4 + cvr * 0.4 + quality * 0.2) * 100;
        }
        
        // 新广告给予默认分数
        return 50.0;
    }
    
    private double calculateQualityScore(AdCandidate candidate, BidRequest request) {
        // 基于机器学习的CTR预估（简化实现）
        double predictedCTR = predictCTR(candidate, request);
        
        // 将CTR转换为质量分数（0-100）
        return Math.min(predictedCTR * 5000, 100.0);
    }
    
    private double predictCTR(AdCandidate candidate, BidRequest request) {
        // 这里应该调用机器学习模型预测CTR
        // 简化实现：基于历史数据和特征计算
        
        double baseCTR = 0.02; // 基础CTR
        
        // 设备类型调整
        if ("mobile".equalsIgnoreCase(request.getDevice().getDeviceType())) {
            baseCTR *= 1.2; // 移动端CTR通常更高
        }
        
        // 时间段调整
        int hour = LocalDateTime.now().getHour();
        if (hour >= 19 && hour <= 23) {
            baseCTR *= 1.3; // 晚间黄金时段
        }
        
        // 广告类型调整
        if (candidate.getCreative().getAdType() == 3) { // 原生广告
            baseCTR *= 1.5; // 原生广告CTR较高
        }
        
        return baseCTR;
    }
    
    private double calculateBidCompetitiveness(AdCandidate candidate, BidRequest request) {
        BigDecimal bidPrice = candidate.getBaseBidPrice();
        BigDecimal floorPrice = request.getSlot().getFloorPrice();
        
        // 计算出价相对于底价的竞争力
        double competitiveness = bidPrice.divide(floorPrice, 4, RoundingMode.HALF_UP).doubleValue();
        
        // 转换为0-100分数
        return Math.min(competitiveness * 20, 100.0);
    }
    
    private double calculateRelevanceScore(AdCandidate candidate, BidRequest request) {
        // 计算广告与用户/上下文的相关性
        double relevance = 50.0; // 基础相关性
        
        // 地域相关性
        if (isLocationRelevant(candidate, request)) {
            relevance += 10.0;
        }
        
        // 时间相关性
        if (isTimeRelevant(candidate, request)) {
            relevance += 10.0;
        }
        
        // 设备相关性
        if (isDeviceRelevant(candidate, request)) {
            relevance += 10.0;
        }
        
        return Math.min(relevance, 100.0);
    }
    
    private boolean isLocationRelevant(AdCandidate candidate, BidRequest request) {
        // 检查广告是否与用户位置相关
        return true; // 简化实现
    }
    
    private boolean isTimeRelevant(AdCandidate candidate, BidRequest request) {
        // 检查广告是否与当前时间相关
        return true; // 简化实现
    }
    
    private boolean isDeviceRelevant(AdCandidate candidate, BidRequest request) {
        // 检查广告是否与用户设备相关
        return true; // 简化实现
    }
    
    private BigDecimal calculateFinalBidPrice(AdCandidate candidate, BidRequest request) {
        AdGroup adGroup = candidate.getAdGroup();
        BigDecimal baseBidPrice = adGroup.getBidPrice();
        
        // 根据竞价策略调整出价
        switch (adGroup.getBidStrategy()) {
            case 1: // CPM
                return calculateCPMBid(candidate, request, baseBidPrice);
            case 2: // CPC
                return calculateCPCBid(candidate, request, baseBidPrice);
            case 3: // CPA
                return calculateCPABid(candidate, request, baseBidPrice);
            case 4: // oCPM (优化CPM)
                return calculateOptimizedCPMBid(candidate, request, baseBidPrice);
            case 5: // oCPC (优化CPC)
                return calculateOptimizedCPCBid(candidate, request, baseBidPrice);
            default:
                return baseBidPrice;
        }
    }
    
    private BigDecimal calculateCPMBid(AdCandidate candidate, BidRequest request, BigDecimal baseBidPrice) {
        // CPM竞价：直接使用基础出价
        return baseBidPrice;
    }
    
    private BigDecimal calculateCPCBid(AdCandidate candidate, BidRequest request, BigDecimal baseBidPrice) {
        // CPC竞价：根据预估CTR调整
        double predictedCTR = predictCTR(candidate, request);
        double adjustmentFactor = Math.max(0.1, Math.min(2.0, predictedCTR / 0.02)); // 基准CTR为2%
        
        return baseBidPrice.multiply(BigDecimal.valueOf(adjustmentFactor))
            .setScale(4, RoundingMode.HALF_UP);
    }
    
    private BigDecimal calculateCPABid(AdCandidate candidate, BidRequest request, BigDecimal baseBidPrice) {
        // CPA竞价：根据预估CVR调整
        double predictedCVR = predictCVR(candidate, request);
        double adjustmentFactor = Math.max(0.1, Math.min(2.0, predictedCVR / 0.05)); // 基准CVR为5%
        
        return baseBidPrice.multiply(BigDecimal.valueOf(adjustmentFactor))
            .setScale(4, RoundingMode.HALF_UP);
    }
    
    private BigDecimal calculateOptimizedCPMBid(AdCandidate candidate, BidRequest request, BigDecimal baseBidPrice) {
        // oCPM：基于质量分数优化
        double qualityScore = calculateQualityScore(candidate, request);
        double adjustmentFactor = Math.max(0.5, Math.min(1.5, qualityScore / 50.0)); // 基准质量分数为50
        
        return baseBidPrice.multiply(BigDecimal.valueOf(adjustmentFactor))
            .setScale(4, RoundingMode.HALF_UP);
    }
    
    private BigDecimal calculateOptimizedCPCBid(AdCandidate candidate, BidRequest request, BigDecimal baseBidPrice) {
        // oCPC：综合CTR和质量分数
        double predictedCTR = predictCTR(candidate, request);
        double qualityScore = calculateQualityScore(candidate, request);
        
        double ctrFactor = Math.max(0.1, Math.min(2.0, predictedCTR / 0.02));
        double qualityFactor = Math.max(0.5, Math.min(1.5, qualityScore / 50.0));
        
        double adjustmentFactor = (ctrFactor * 0.7 + qualityFactor * 0.3);
        
        return baseBidPrice.multiply(BigDecimal.valueOf(adjustmentFactor))
            .setScale(4, RoundingMode.HALF_UP);
    }
    
    private double predictCVR(AdCandidate candidate, BidRequest request) {
        // 预估转化率（简化实现）
        double baseCVR = 0.05; // 基础CVR为5%
        
        // 基于历史数据调整
        // 实际应用中需要机器学习模型
        
        return baseCVR;
    }
}
```

### 7. 广告候选对象 (AdCandidate.java)

```java
@Data
@AllArgsConstructor
@NoArgsConstructor
public class AdCandidate {
    
    private Long advertiserId;
    private Long campaignId;
    private Long adGroupId;
    private Long creativeId;
    
    private AdGroup adGroup;
    private Creative creative;
    
    private BigDecimal baseBidPrice;
    private BigDecimal bidPrice;
    private double bidScore;
    
    // 广告内容
    private String title;
    private String description;
    private String imageUrl;
    private String videoUrl;
    private String clickUrl;
    
    // 定向信息
    private String targetRegion;
    private String targetOs;
    private String targetDeviceType;
    private String targetDeviceMake;
    private String targetDeviceModel;
    private String targetCarrier;
    private String targetNetwork;
    
    // 预算信息
    private BigDecimal dailyBudget;
    private BigDecimal remainingBudget;
    
    // 频次信息
    private Integer frequencyCap;
    private Integer frequencyCapPeriod;
    
    // 质量指标
    private Double predictedCTR;
    private Double predictedCVR;
    private Double qualityScore;
    
    /**
     * 从AdGroup和Creative构建AdCandidate
     */
    public static AdCandidate fromAdGroupAndCreative(AdGroup adGroup, Creative creative) {
        AdCandidate candidate = new AdCandidate();
        
        candidate.setAdvertiserId(adGroup.getAdvertiserId());
        candidate.setCampaignId(adGroup.getCampaignId());
        candidate.setAdGroupId(adGroup.getId());
        candidate.setCreativeId(creative.getId());
        
        candidate.setAdGroup(adGroup);
        candidate.setCreative(creative);
        
        candidate.setBaseBidPrice(adGroup.getBidPrice());
        candidate.setDailyBudget(adGroup.getDailyBudget());
        
        candidate.setTitle(creative.getTitle());
        candidate.setDescription(creative.getDescription());
        candidate.setImageUrl(creative.getImageUrl());
        candidate.setVideoUrl(creative.getVideoUrl());
        candidate.setClickUrl(creative.getClickUrl());
        
        candidate.setTargetRegion(adGroup.getTargetRegion());
        candidate.setTargetOs(adGroup.getTargetOs());
        candidate.setTargetDeviceType(adGroup.getTargetDeviceType());
        candidate.setTargetDeviceMake(adGroup.getTargetDeviceMake());
        candidate.setTargetDeviceModel(adGroup.getTargetDeviceModel());
        candidate.setTargetCarrier(adGroup.getTargetCarrier());
        candidate.setTargetNetwork(adGroup.getTargetNetwork());
        
        candidate.setFrequencyCap(adGroup.getFrequencyCap());
        candidate.setFrequencyCapPeriod(adGroup.getFrequencyCapPeriod());
        
        return candidate;
    }
    
    /**
     * 检查广告是否满足基本条件
     */
    public boolean isValid() {
        return advertiserId != null
            && campaignId != null
            && adGroupId != null
            && creativeId != null
            && baseBidPrice != null
            && baseBidPrice.compareTo(BigDecimal.ZERO) > 0
            && StringUtils.isNotBlank(clickUrl);
    }
    
    /**
     * 计算广告的整体质量分数
     */
    public double calculateOverallQuality() {
        double quality = 0.0;
        
        // 预估CTR权重40%
        if (predictedCTR != null) {
            quality += predictedCTR * 40;
        }
        
        // 预估CVR权重30%
        if (predictedCVR != null) {
            quality += predictedCVR * 30;
        }
        
        // 质量分数权重30%
        if (qualityScore != null) {
            quality += qualityScore * 0.3;
        }
        
        return quality;
    }
}
```

## 部署指南

### 1. 环境要求

- **Java**: 17+
- **MySQL**: 8.0+
- **Redis**: 6.0+
- **Maven**: 3.8+

### 2. 数据库初始化

```bash
# 执行SQL脚本
mysql -u root -p < sql/01_create_database.sql
mysql -u root -p < sql/02_advertiser_tables.sql
mysql -u root -p < sql/03_campaign_tables.sql
mysql -u root -p < sql/04_statistics_tables.sql
mysql -u root -p < sql/05_init_data.sql
```

### 3. 配置文件

```properties
# application.properties
spring.datasource.url=jdbc:mysql://localhost:3306/opendsp
spring.datasource.username=root
spring.datasource.password=your_password
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver

# Redis配置
spring.redis.host=localhost
spring.redis.port=6379
spring.redis.password=
spring.redis.database=0

# MyBatis配置
mybatis-flex.mapper-locations=classpath:mapper/*.xml
mybatis-flex.type-aliases-package=io.github.javagossip.opendsp.model

# 日志配置
logging.level.root=INFO
logging.level.io.github.javagossip.opendsp=DEBUG
```

### 4. 启动服务

```bash
# 启动广告引擎服务
cd opendsp-ads-engine/opendsp-ads-engine-serving
mvn spring-boot:run

# 启动管理后台API
cd opendsp-dashboard-api
mvn spring-boot:run

# 启动事件处理服务
cd opendsp-event-serving/opendsp-click-serving
mvn spring-boot:run

cd opendsp-event-serving/opendsp-impression-serving
mvn spring-boot:run
```

## 监控与运维

### 1. 关键指标监控

- **QPS**: 每秒查询数
- **延迟**: 平均响应时间
- **成功率**: 竞价成功率
- **预算消耗**: 实时预算消耗监控
- **CTR/CVR**: 点击率和转化率

### 2. 告警配置

- 服务异常告警
- 预算耗尽告警
- 数据库连接异常告警
- Redis连接异常告警

### 3. 性能优化建议

1. **缓存策略**: 合理使用Redis缓存热点数据
2. **数据库优化**: 建立合适的索引，分库分表
3. **异步处理**: 使用消息队列处理非实时任务
4. **负载均衡**: 部署多个实例，使用负载均衡
5. **CDN加速**: 静态资源使用CDN加速

## 功能扩展

### 1. 机器学习集成

- CTR预估模型
- CVR预估模型
- 智能出价算法
- 用户画像分析

### 2. 数据分析

- 实时数据大屏
- 多维度报表分析
- 竞价效果分析
- 成本效益分析

### 3. 高级功能

- 私有交易市场(PMP)
- 程序化直投(PDB)
- 动态创意优化(DCO)
- 跨屏投放管理

## 总结

本OpenDSP平台实现了完整的程序化广告投放功能，包括：

1. **完整的RTB竞价流程**: 从请求验证到最终响应的7步处理流程
2. **智能广告匹配**: 基于广告位特征和活跃状态的精准匹配
3. **多维度定向**: 支持地域、设备、网络等7个维度的精准定向
4. **双重预算控制**: 广告主余额和广告组日预算的双重保障
5. **频次控制**: 基于Redis的高效用户频次管理
6. **智能定价**: 支持5种竞价策略的智能出价系统
7. **完整的数据模型**: 23张表覆盖完整的DSP业务流程

该平台具备商业化部署的基础条件，通过合理的架构设计和性能优化，可以支撑大规模的广告投放需求。 