# OpenDSP 生产环境部署运维文档

## 文档概述

本文档详细介绍OpenDSP（需求方平台）在生产环境的部署、配置、监控和运维方案，涵盖从基础环境搭建到高可用架构的完整部署流程。

## 目录
- [1. 架构设计](#1-架构设计)
- [2. 环境要求](#2-环境要求)
- [3. 基础环境搭建](#3-基础环境搭建)
- [4. 应用部署](#4-应用部署)
- [5. 配置管理](#5-配置管理)
- [6. 监控体系](#6-监控体系)
- [7. 日志管理](#7-日志管理)
- [8. 备份策略](#8-备份策略)
- [9. 高可用架构](#9-高可用架构)
- [10. 容器化部署](#10-容器化部署)
- [11. 性能优化](#11-性能优化)
- [12. 安全配置](#12-安全配置)
- [13. 故障排查](#13-故障排查)
- [14. 运维脚本](#14-运维脚本)

---

## 1. 架构设计

### 1.1 整体架构图
```
                    [负载均衡器 - Nginx]
                           |
                    [API网关 - Gateway]
                           |
            +---------------+---------------+
            |               |               |
    [广告引擎服务]    [管理后台API]    [事件处理服务]
    (RTB竞价核心)    (Dashboard)     (点击/展示)
            |               |               |
            +---------------+---------------+
                           |
                    [数据访问层 - DAO]
                           |
            +---------------+---------------+
            |               |               |
        [MySQL集群]     [Redis集群]    [消息队列]
        (主从复制)      (哨兵模式)     (RabbitMQ)
```

### 1.2 服务拆分
- **opendsp-ads-engine-serving**: 广告引擎服务 (端口: 8080)
- **opendsp-dashboard-api**: 管理后台API (端口: 8081)
- **opendsp-click-serving**: 点击事件服务 (端口: 8082)
- **opendsp-impression-serving**: 展示事件服务 (端口: 8083)

### 1.3 数据流图
```
[广告主] -> [管理后台] -> [MySQL] -> [广告引擎] -> [Redis缓存]
                                         |
[ADX] -> [RTB请求] -> [广告引擎] -> [竞价响应] -> [ADX]
                         |
                    [事件回调] -> [事件服务] -> [统计入库]
```

---

## 2. 环境要求

### 2.1 硬件配置

#### 生产环境（高可用）
```yaml
# 应用服务器（3台）
CPU: 8核 Intel Xeon
内存: 32GB DDR4
硬盘: 500GB SSD + 2TB HDD
网络: 千兆网卡

# 数据库服务器（3台）
CPU: 16核 Intel Xeon
内存: 64GB DDR4
硬盘: 1TB SSD (系统) + 4TB SSD (数据)
网络: 千兆网卡

# 缓存服务器（3台）
CPU: 8核 Intel Xeon
内存: 64GB DDR4
硬盘: 200GB SSD
网络: 千兆网卡
```

#### 测试环境（单机）
```yaml
CPU: 4核
内存: 16GB
硬盘: 200GB SSD
网络: 百兆网卡
```

### 2.2 软件环境
```yaml
操作系统: CentOS 7.9 / Ubuntu 20.04 LTS
JDK版本: OpenJDK 17+
数据库: MySQL 8.0.28+
缓存: Redis 6.2.6+
消息队列: RabbitMQ 3.9.13+
Web服务器: Nginx 1.20+
容器: Docker 20.10+ / Kubernetes 1.22+
监控: Prometheus 2.32+ / Grafana 8.3+
```

---

## 3. 基础环境搭建

### 3.1 操作系统初始化

#### 系统优化配置
```bash
#!/bin/bash
# 系统初始化脚本

# 关闭防火墙（生产环境请谨慎）
systemctl stop firewalld
systemctl disable firewalld

# 关闭SELinux
sed -i 's/SELINUX=enforcing/SELINUX=disabled/' /etc/selinux/config

# 设置系统时区
timedatectl set-timezone Asia/Shanghai

# 增加文件描述符限制
cat >> /etc/security/limits.conf << EOF
* soft nofile 65535
* hard nofile 65535
* soft nproc 65535
* hard nproc 65535
EOF

# 内核参数优化
cat >> /etc/sysctl.conf << EOF
# 网络优化
net.core.somaxconn = 65535
net.core.netdev_max_backlog = 5000
net.ipv4.tcp_max_syn_backlog = 65535
net.ipv4.tcp_fin_timeout = 10
net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp_tw_recycle = 1

# 内存优化
vm.swappiness = 10
vm.dirty_ratio = 15
vm.dirty_background_ratio = 5

# 文件系统优化
fs.file-max = 2097152
fs.nr_open = 2097152
EOF

sysctl -p
```

### 3.2 JDK安装配置

#### OpenJDK 17 安装
```bash
#!/bin/bash
# JDK安装脚本

# 下载并安装OpenJDK 17
cd /opt
wget https://download.java.net/java/GA/jdk17/0d483333a00540d886896bac774ff48b/35/GPL/openjdk-17_linux-x64_bin.tar.gz
tar -xzf openjdk-17_linux-x64_bin.tar.gz
mv jdk-17 java

# 配置环境变量
cat >> /etc/profile << EOF
export JAVA_HOME=/opt/java
export JRE_HOME=\$JAVA_HOME/jre
export CLASSPATH=\$JAVA_HOME/lib:\$JRE_HOME/lib
export PATH=\$JAVA_HOME/bin:\$PATH
EOF

source /etc/profile

# 验证安装
java -version
```

#### JVM参数配置
```bash
# 广告引擎服务JVM参数（高性能配置）
JAVA_OPTS="-server \
-Xms8g -Xmx8g \
-XX:NewRatio=1 \
-XX:SurvivorRatio=8 \
-XX:+UseG1GC \
-XX:MaxGCPauseMillis=200 \
-XX:G1HeapRegionSize=16m \
-XX:+UseStringDeduplication \
-XX:+PrintGC \
-XX:+PrintGCDetails \
-XX:+PrintGCTimeStamps \
-XX:+PrintGCApplicationStoppedTime \
-Xloggc:/opt/opendsp/logs/gc.log \
-XX:+UseGCLogFileRotation \
-XX:NumberOfGCLogFiles=5 \
-XX:GCLogFileSize=100M \
-Djava.awt.headless=true \
-Dfile.encoding=UTF-8 \
-Duser.timezone=Asia/Shanghai"
```

### 3.3 MySQL集群搭建

#### 主从复制配置

**主服务器配置 (mysql-master: 192.168.1.10)**
```ini
# /etc/mysql/mysql.conf.d/mysqld.cnf

[mysqld]
# 基础配置
server-id = 1
log-bin = mysql-bin
binlog-format = ROW
expire_logs_days = 7
max_binlog_size = 100M

# 性能优化
innodb_buffer_pool_size = 32G
innodb_log_file_size = 1G
innodb_log_buffer_size = 64M
innodb_flush_log_at_trx_commit = 1
innodb_flush_method = O_DIRECT
innodb_lock_wait_timeout = 120

# 连接配置
max_connections = 2000
max_connect_errors = 1000
wait_timeout = 28800
interactive_timeout = 28800

# 查询缓存
query_cache_type = 1
query_cache_size = 128M
query_cache_limit = 2M

# 慢查询日志
slow_query_log = 1
slow_query_log_file = /var/log/mysql/slow.log
long_query_time = 2
```

**从服务器配置 (mysql-slave: 192.168.1.11)**
```ini
# /etc/mysql/mysql.conf.d/mysqld.cnf

[mysqld]
server-id = 2
relay-log = mysql-relay-bin
log-slave-updates = 1
read-only = 1

# 其他配置与主服务器相同
```

**主从同步设置**
```sql
-- 主服务器上创建复制用户
CREATE USER 'repl'@'192.168.1.%' IDENTIFIED BY 'repl_password';
GRANT REPLICATION SLAVE ON *.* TO 'repl'@'192.168.1.%';
FLUSH PRIVILEGES;

-- 查看主服务器状态
SHOW MASTER STATUS;

-- 从服务器上配置同步
CHANGE MASTER TO
  MASTER_HOST='192.168.1.10',
  MASTER_USER='repl',
  MASTER_PASSWORD='repl_password',
  MASTER_LOG_FILE='mysql-bin.000001',
  MASTER_LOG_POS=154;

START SLAVE;
SHOW SLAVE STATUS\G;
```

### 3.4 Redis集群搭建

#### 哨兵模式配置

**Redis主服务器配置 (redis-master: 192.168.1.20)**
```ini
# /etc/redis/redis.conf
bind 0.0.0.0
port 6379
daemonize yes
pidfile /var/run/redis/redis-server.pid
logfile /var/log/redis/redis-server.log
dir /var/lib/redis

# 内存配置
maxmemory 48gb
maxmemory-policy allkeys-lru

# 持久化配置
save 900 1
save 300 10
save 60 10000
rdbcompression yes
rdbchecksum yes
dbfilename dump.rdb

# AOF配置
appendonly yes
appendfilename "appendonly.aof"
appendfsync everysec
no-appendfsync-on-rewrite no
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# 安全配置
requirepass redis_password
```

**Redis从服务器配置 (redis-slave: 192.168.1.21)**
```ini
# 继承主服务器配置，添加：
slaveof 192.168.1.20 6379
masterauth redis_password
slave-read-only yes
```

**哨兵配置 (三台哨兵服务器)**
```ini
# /etc/redis/sentinel.conf
port 26379
daemonize yes
pidfile /var/run/redis/redis-sentinel.pid
logfile /var/log/redis/redis-sentinel.log
dir /tmp

# 监控配置
sentinel monitor mymaster 192.168.1.20 6379 2
sentinel auth-pass mymaster redis_password
sentinel down-after-milliseconds mymaster 30000
sentinel parallel-syncs mymaster 1
sentinel failover-timeout mymaster 180000
```

### 3.5 Nginx负载均衡配置

```nginx
# /etc/nginx/nginx.conf

user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log;
pid /run/nginx.pid;

events {
    worker_connections 65535;
    use epoll;
    multi_accept on;
}

http {
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for" '
                    '$request_time $upstream_response_time';

    access_log /var/log/nginx/access.log main;

    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    client_max_body_size 100M;

    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # 压缩配置
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css application/json application/javascript;

    # 上游服务器配置
    upstream ads_engine {
        least_conn;
        server 192.168.1.30:8080 max_fails=3 fail_timeout=30s;
        server 192.168.1.31:8080 max_fails=3 fail_timeout=30s;
        server 192.168.1.32:8080 max_fails=3 fail_timeout=30s;
        keepalive 32;
    }

    upstream dashboard_api {
        least_conn;
        server 192.168.1.30:8081 max_fails=3 fail_timeout=30s;
        server 192.168.1.31:8081 max_fails=3 fail_timeout=30s;
        server 192.168.1.32:8081 max_fails=3 fail_timeout=30s;
        keepalive 32;
    }

    upstream event_services {
        least_conn;
        server 192.168.1.30:8082 max_fails=3 fail_timeout=30s;
        server 192.168.1.30:8083 max_fails=3 fail_timeout=30s;
        server 192.168.1.31:8082 max_fails=3 fail_timeout=30s;
        server 192.168.1.31:8083 max_fails=3 fail_timeout=30s;
        keepalive 32;
    }

    # 广告引擎服务
    server {
        listen 80;
        server_name ads.opendsp.com;

        location / {
            proxy_pass http://ads_engine;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            proxy_connect_timeout 5s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
            
            proxy_buffering on;
            proxy_buffer_size 4k;
            proxy_buffers 8 4k;
            proxy_busy_buffers_size 8k;
        }

        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }
    }

    # 管理后台API
    server {
        listen 80;
        server_name api.opendsp.com;

        location / {
            proxy_pass http://dashboard_api;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            proxy_connect_timeout 10s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }
    }

    # 事件处理服务
    server {
        listen 80;
        server_name events.opendsp.com;

        location / {
            proxy_pass http://event_services;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            proxy_connect_timeout 3s;
            proxy_send_timeout 10s;
            proxy_read_timeout 10s;
        }
    }
}
```

---

## 4. 应用部署

### 4.1 目录结构规划

```
/opt/opendsp/
├── apps/                    # 应用程序目录
│   ├── ads-engine/         # 广告引擎服务
│   ├── dashboard-api/      # 管理后台API
│   ├── click-serving/      # 点击事件服务
│   └── impression-serving/ # 展示事件服务
├── config/                 # 配置文件目录
│   ├── application.yml     # 主配置文件
│   ├── logback-spring.xml  # 日志配置
│   └── profiles/           # 环境配置
│       ├── dev/
│       ├── test/
│       └── prod/
├── logs/                   # 日志目录
│   ├── ads-engine/
│   ├── dashboard-api/
│   ├── click-serving/
│   └── impression-serving/
├── scripts/                # 运维脚本
│   ├── deploy.sh          # 部署脚本
│   ├── start.sh           # 启动脚本
│   ├── stop.sh            # 停止脚本
│   └── health-check.sh    # 健康检查脚本
└── backup/                 # 备份目录
    ├── config/
    └── data/
```

### 4.2 部署脚本

#### 主部署脚本
```bash
#!/bin/bash
# 部署脚本: /opt/opendsp/scripts/deploy.sh

set -e

# 配置变量
DEPLOY_USER="opendsp"
DEPLOY_DIR="/opt/opendsp"
BACKUP_DIR="/opt/opendsp/backup"
APPS_DIR="/opt/opendsp/apps"
CONFIG_DIR="/opt/opendsp/config"
LOGS_DIR="/opt/opendsp/logs"

# 服务列表
SERVICES=("ads-engine" "dashboard-api" "click-serving" "impression-serving")

# 函数：打印日志
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1"
}

# 函数：创建目录结构
create_directories() {
    log "创建目录结构..."
    
    for service in "${SERVICES[@]}"; do
        mkdir -p "${APPS_DIR}/${service}"
        mkdir -p "${LOGS_DIR}/${service}"
        mkdir -p "${BACKUP_DIR}/${service}"
    done
    
    mkdir -p "${CONFIG_DIR}/profiles/prod"
    
    # 设置权限
    chown -R ${DEPLOY_USER}:${DEPLOY_USER} ${DEPLOY_DIR}
    chmod -R 755 ${DEPLOY_DIR}
}

# 函数：备份当前版本
backup_current() {
    log "备份当前版本..."
    
    timestamp=$(date +%Y%m%d_%H%M%S)
    backup_path="${BACKUP_DIR}/backup_${timestamp}"
    
    mkdir -p "${backup_path}"
    
    for service in "${SERVICES[@]}"; do
        if [ -f "${APPS_DIR}/${service}/${service}.jar" ]; then
            cp "${APPS_DIR}/${service}/${service}.jar" "${backup_path}/"
            log "备份 ${service} 完成"
        fi
    done
}

# 函数：停止服务
stop_services() {
    log "停止服务..."
    
    for service in "${SERVICES[@]}"; do
        pid=$(ps -ef | grep "${service}.jar" | grep -v grep | awk '{print $2}')
        if [ -n "$pid" ]; then
            log "停止 ${service} (PID: ${pid})"
            kill -15 $pid
            
            # 等待优雅关闭
            for i in {1..30}; do
                if ! ps -p $pid > /dev/null 2>&1; then
                    break
                fi
                sleep 1
            done
            
            # 强制杀死
            if ps -p $pid > /dev/null 2>&1; then
                kill -9 $pid
                log "强制停止 ${service}"
            fi
        fi
    done
}

# 函数：部署新版本
deploy_new() {
    log "部署新版本..."
    
    if [ -z "$1" ]; then
        log "错误: 请指定构建目录"
        exit 1
    fi
    
    build_dir="$1"
    
    for service in "${SERVICES[@]}"; do
        if [ -f "${build_dir}/${service}.jar" ]; then
            cp "${build_dir}/${service}.jar" "${APPS_DIR}/${service}/"
            log "部署 ${service} 完成"
        else
            log "警告: ${service}.jar 不存在"
        fi
    done
}

# 函数：启动服务
start_services() {
    log "启动服务..."
    
    for service in "${SERVICES[@]}"; do
        if [ -f "${APPS_DIR}/${service}/${service}.jar" ]; then
            log "启动 ${service}..."
            
            cd "${APPS_DIR}/${service}"
            
            nohup java ${JAVA_OPTS} \
                -Dspring.profiles.active=prod \
                -Dlogging.config=${CONFIG_DIR}/logback-spring.xml \
                -jar ${service}.jar \
                > "${LOGS_DIR}/${service}/startup.log" 2>&1 &
            
            echo $! > "${APPS_DIR}/${service}/${service}.pid"
            
            # 等待启动
            sleep 10
            
            # 健康检查
            if check_health "${service}"; then
                log "${service} 启动成功"
            else
                log "错误: ${service} 启动失败"
                exit 1
            fi
        fi
    done
}

# 函数：健康检查
check_health() {
    local service="$1"
    local port
    
    case $service in
        "ads-engine") port=8080 ;;
        "dashboard-api") port=8081 ;;
        "click-serving") port=8082 ;;
        "impression-serving") port=8083 ;;
    esac
    
    for i in {1..30}; do
        if curl -f -s "http://localhost:${port}/actuator/health" > /dev/null; then
            return 0
        fi
        sleep 2
    done
    
    return 1
}

# 主流程
main() {
    log "开始部署 OpenDSP 应用..."
    
    create_directories
    backup_current
    stop_services
    deploy_new "$1"
    start_services
    
    log "部署完成!"
}

# 执行主流程
main "$@"
```

### 4.3 启动脚本

#### 服务启动脚本
```bash
#!/bin/bash
# 启动脚本: /opt/opendsp/scripts/start.sh

DEPLOY_DIR="/opt/opendsp"
APPS_DIR="${DEPLOY_DIR}/apps"
CONFIG_DIR="${DEPLOY_DIR}/config"
LOGS_DIR="${DEPLOY_DIR}/logs"

# JVM参数配置
get_jvm_opts() {
    local service="$1"
    local heap_size
    
    case $service in
        "ads-engine")
            heap_size="8g"
            ;;
        "dashboard-api")
            heap_size="4g"
            ;;
        *)
            heap_size="2g"
            ;;
    esac
    
    echo "-server \
-Xms${heap_size} -Xmx${heap_size} \
-XX:NewRatio=1 \
-XX:SurvivorRatio=8 \
-XX:+UseG1GC \
-XX:MaxGCPauseMillis=200 \
-XX:G1HeapRegionSize=16m \
-XX:+UseStringDeduplication \
-XX:+PrintGC \
-XX:+PrintGCDetails \
-XX:+PrintGCTimeStamps \
-Xloggc:${LOGS_DIR}/${service}/gc.log \
-XX:+UseGCLogFileRotation \
-XX:NumberOfGCLogFiles=5 \
-XX:GCLogFileSize=100M \
-Djava.awt.headless=true \
-Dfile.encoding=UTF-8 \
-Duser.timezone=Asia/Shanghai"
}

# 启动单个服务
start_service() {
    local service="$1"
    local jar_file="${APPS_DIR}/${service}/${service}.jar"
    local pid_file="${APPS_DIR}/${service}/${service}.pid"
    
    if [ ! -f "$jar_file" ]; then
        echo "错误: ${jar_file} 不存在"
        return 1
    fi
    
    if [ -f "$pid_file" ]; then
        local pid=$(cat "$pid_file")
        if ps -p $pid > /dev/null 2>&1; then
            echo "${service} 已在运行 (PID: ${pid})"
            return 0
        fi
    fi
    
    echo "启动 ${service}..."
    
    cd "${APPS_DIR}/${service}"
    
    local jvm_opts=$(get_jvm_opts "$service")
    
    nohup java ${jvm_opts} \
        -Dspring.profiles.active=prod \
        -Dspring.config.location=${CONFIG_DIR}/application.yml \
        -Dlogging.config=${CONFIG_DIR}/logback-spring.xml \
        -jar "$jar_file" \
        > "${LOGS_DIR}/${service}/startup.log" 2>&1 &
    
    echo $! > "$pid_file"
    
    # 等待启动
    sleep 5
    
    if ps -p $(cat "$pid_file") > /dev/null 2>&1; then
        echo "${service} 启动成功 (PID: $(cat "$pid_file"))"
    else
        echo "${service} 启动失败"
        return 1
    fi
}

# 主函数
main() {
    local services=("ads-engine" "dashboard-api" "click-serving" "impression-serving")
    
    if [ -n "$1" ]; then
        # 启动指定服务
        start_service "$1"
    else
        # 启动所有服务
        for service in "${services[@]}"; do
            start_service "$service"
            sleep 2
        done
    fi
}

main "$@"
```

#### 停止脚本
```bash
#!/bin/bash
# 停止脚本: /opt/opendsp/scripts/stop.sh

APPS_DIR="/opt/opendsp/apps"

# 停止单个服务
stop_service() {
    local service="$1"
    local pid_file="${APPS_DIR}/${service}/${service}.pid"
    
    if [ ! -f "$pid_file" ]; then
        echo "${service} 未运行"
        return 0
    fi
    
    local pid=$(cat "$pid_file")
    
    if ! ps -p $pid > /dev/null 2>&1; then
        echo "${service} 未运行"
        rm -f "$pid_file"
        return 0
    fi
    
    echo "停止 ${service} (PID: ${pid})"
    
    # 优雅关闭
    kill -15 $pid
    
    # 等待30秒
    for i in {1..30}; do
        if ! ps -p $pid > /dev/null 2>&1; then
            echo "${service} 已停止"
            rm -f "$pid_file"
            return 0
        fi
        sleep 1
    done
    
    # 强制关闭
    echo "强制停止 ${service}"
    kill -9 $pid
    rm -f "$pid_file"
}

# 主函数
main() {
    local services=("ads-engine" "dashboard-api" "click-serving" "impression-serving")
    
    if [ -n "$1" ]; then
        # 停止指定服务
        stop_service "$1"
    else
        # 停止所有服务
        for service in "${services[@]}"; do
            stop_service "$service"
        done
    fi
}

main "$@"
```

---

## 5. 配置管理

### 5.1 主配置文件

```yaml
# /opt/opendsp/config/application.yml

# 服务器配置
server:
  port: 8080
  servlet:
    context-path: /
  tomcat:
    threads:
      max: 1000
      min-spare: 100
    connection-timeout: 30000
    max-connections: 10000
    accept-count: 1000

# Spring配置
spring:
  application:
    name: opendsp-ads-engine
  profiles:
    active: prod
  
  # 数据源配置
  datasource:
    type: com.zaxxer.hikari.HikariDataSource
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://192.168.1.10:3306/opendsp?useUnicode=true&characterEncoding=utf8&serverTimezone=Asia/Shanghai&useSSL=false&allowPublicKeyRetrieval=true&rewriteBatchedStatements=true
    username: ${DB_USERNAME:opendsp}
    password: ${DB_PASSWORD:opendsp123}
    hikari:
      minimum-idle: 10
      maximum-pool-size: 100
      idle-timeout: 300000
      connection-timeout: 30000
      max-lifetime: 1800000
      leak-detection-threshold: 60000
      connection-test-query: SELECT 1
  
  # Redis配置
  redis:
    sentinel:
      master: mymaster
      nodes: 
        - 192.168.1.20:26379
        - 192.168.1.21:26379
        - 192.168.1.22:26379
    password: ${REDIS_PASSWORD:redis123}
    timeout: 3000
    lettuce:
      pool:
        max-active: 200
        max-idle: 50
        min-idle: 10
        max-wait: 3000
  
  # RabbitMQ配置
  rabbitmq:
    host: 192.168.1.40
    port: 5672
    username: ${MQ_USERNAME:opendsp}
    password: ${MQ_PASSWORD:mq123}
    virtual-host: opendsp
    connection-timeout: 15000
    publisher-confirms: true
    publisher-returns: true
    listener:
      simple:
        acknowledge-mode: manual
        concurrency: 5
        max-concurrency: 20
        prefetch: 10

# MyBatis配置
mybatis-flex:
  mapper-locations: classpath:mapper/*.xml
  type-aliases-package: io.github.javagossip.opendsp.model
  configuration:
    map-underscore-to-camel-case: true
    default-fetch-size: 100
    default-statement-timeout: 30

# 执行器配置
executor:
  core-pool-size: 20
  max-pool-size: 200
  queue-capacity: 1000
  keep-alive-seconds: 60
  thread-name-prefix: opendsp-

# 应用监控
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
  endpoint:
    health:
      show-details: always
  metrics:
    export:
      prometheus:
        enabled: true

# 应用特定配置
opendsp:
  # 竞价配置
  bidding:
    timeout: 100
    max-candidates: 50
    enable-frequency-cap: true
    enable-budget-check: true
  
  # 缓存配置
  cache:
    ad-matching:
      ttl: 300
    budget:
      ttl: 60
    targeting:
      ttl: 600
  
  # 性能配置
  performance:
    async-logging: true
    batch-size: 1000
    flush-interval: 5000

# 日志配置
logging:
  config: classpath:logback-spring.xml
  level:
    root: INFO
    io.github.javagossip.opendsp: DEBUG
    org.springframework: WARN
    com.zaxxer.hikari: WARN
```

### 5.2 日志配置

```xml
<!-- /opt/opendsp/config/logback-spring.xml -->

<?xml version="1.0" encoding="UTF-8"?>
<configuration scan="true" scanPeriod="30 seconds">
    
    <!-- 日志文件路径 -->
    <property name="LOG_PATH" value="/opt/opendsp/logs/${spring.application.name:-opendsp}"/>
    
    <!-- 日志格式 -->
    <property name="LOG_PATTERN" value="%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{50} - %msg%n"/>
    
    <!-- 控制台输出 -->
    <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
        <encoder>
            <pattern>${LOG_PATTERN}</pattern>
        </encoder>
    </appender>
    
    <!-- 应用日志 -->
    <appender name="FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>${LOG_PATH}/application.log</file>
        <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
            <fileNamePattern>${LOG_PATH}/application.%d{yyyy-MM-dd}.%i.log.gz</fileNamePattern>
            <maxFileSize>500MB</maxFileSize>
            <maxHistory>30</maxHistory>
            <totalSizeCap>10GB</totalSizeCap>
        </rollingPolicy>
        <encoder>
            <pattern>${LOG_PATTERN}</pattern>
        </encoder>
    </appender>
    
    <!-- 错误日志 -->
    <appender name="ERROR_FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>${LOG_PATH}/error.log</file>
        <filter class="ch.qos.logback.classic.filter.LevelFilter">
            <level>ERROR</level>
            <onMatch>ACCEPT</onMatch>
            <onMismatch>DENY</onMismatch>
        </filter>
        <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
            <fileNamePattern>${LOG_PATH}/error.%d{yyyy-MM-dd}.%i.log.gz</fileNamePattern>
            <maxFileSize>100MB</maxFileSize>
            <maxHistory>60</maxHistory>
            <totalSizeCap>5GB</totalSizeCap>
        </rollingPolicy>
        <encoder>
            <pattern>${LOG_PATTERN}</pattern>
        </encoder>
    </appender>
    
    <!-- 竞价日志 -->
    <appender name="BID_FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>${LOG_PATH}/bidding.log</file>
        <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
            <fileNamePattern>${LOG_PATH}/bidding.%d{yyyy-MM-dd}.%i.log.gz</fileNamePattern>
            <maxFileSize>1GB</maxFileSize>
            <maxHistory>7</maxHistory>
            <totalSizeCap>20GB</totalSizeCap>
        </rollingPolicy>
        <encoder>
            <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} %msg%n</pattern>
        </encoder>
    </appender>
    
    <!-- 异步日志 -->
    <appender name="ASYNC_FILE" class="ch.qos.logback.classic.AsyncAppender">
        <discardingThreshold>0</discardingThreshold>
        <queueSize>2048</queueSize>
        <appender-ref ref="FILE"/>
    </appender>
    
    <appender name="ASYNC_ERROR" class="ch.qos.logback.classic.AsyncAppender">
        <discardingThreshold>0</discardingThreshold>
        <queueSize>512</queueSize>
        <appender-ref ref="ERROR_FILE"/>
    </appender>
    
    <!-- 竞价服务专用日志 -->
    <logger name="io.github.javagossip.opendsp.ads.engine.service.BiddingServiceImpl" 
            level="INFO" additivity="false">
        <appender-ref ref="BID_FILE"/>
    </logger>
    
    <!-- 根日志级别 -->
    <springProfile name="dev">
        <root level="DEBUG">
            <appender-ref ref="CONSOLE"/>
            <appender-ref ref="ASYNC_FILE"/>
            <appender-ref ref="ASYNC_ERROR"/>
        </root>
    </springProfile>
    
    <springProfile name="prod">
        <root level="INFO">
            <appender-ref ref="ASYNC_FILE"/>
            <appender-ref ref="ASYNC_ERROR"/>
        </root>
    </springProfile>
    
</configuration>
```

**文档将继续...** 